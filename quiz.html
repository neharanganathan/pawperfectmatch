<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Pawperfect Match ‚Äî Quiz</title>
  <style>
    :root{
      --bg1:#0b1220;
      --bg2:#111a2e;
      --card: rgba(255,255,255,0.08);
      --card2: rgba(255,255,255,0.10);
      --text:#eef2ff;
      --muted: rgba(238,242,255,0.75);
      --accent:#7c3aed;
      --accent2:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
      --shadow: 0 18px 60px rgba(0,0,0,0.35);
      --radius: 18px;
    }

    *{ box-sizing: border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color: var(--text);
      background:
        radial-gradient(1200px 700px at 20% -10%, rgba(124,58,237,0.45), transparent 60%),
        radial-gradient(900px 600px at 110% 20%, rgba(34,197,94,0.25), transparent 55%),
        radial-gradient(800px 500px at 40% 120%, rgba(245,158,11,0.18), transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      min-height:100vh;
      overflow-x:hidden;
    }

    /* Subtle animated sparkle dots */
    .sparkles{position:fixed;inset:0;pointer-events:none;opacity:0.55;background-image:radial-gradient(2px 2px at 12% 20%, rgba(255,255,255,0.35), transparent 60%),radial-gradient(1.5px 1.5px at 70% 35%, rgba(255,255,255,0.25), transparent 60%),radial-gradient(2px 2px at 82% 78%, rgba(255,255,255,0.30), transparent 60%),radial-gradient(1.5px 1.5px at 26% 86%, rgba(255,255,255,0.22), transparent 60%),radial-gradient(2px 2px at 50% 55%, rgba(255,255,255,0.20), transparent 60%);animation: floaty 10s ease-in-out infinite}
    @keyframes floaty{0%,100%{ transform: translateY(0px); }50%{ transform: translateY(-10px); }}

    header{padding: 34px 18px 18px;max-width: 1100px;margin: 0 auto;}
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:44px;height:44px;border-radius:14px;background: linear-gradient(135deg, rgba(124,58,237,0.9), rgba(34,197,94,0.75));box-shadow: var(--shadow);display:grid;place-items:center;position:relative;overflow:hidden}
    .logo span{position:relative;font-size:20px;filter: drop-shadow(0 8px 12px rgba(0,0,0,0.35));}
    h1{margin:0;font-size:26px;letter-spacing:0.2px}
    .subtitle{margin:6px 0 0;color:var(--muted);line-height:1.45;max-width:820px}
    .chiprow{display:flex;gap:10px;flex-wrap:nowrap;align-items:center}
    .chip{border:1px solid rgba(255,255,255,0.14);background: rgba(255,255,255,0.06);padding:8px 11px;border-radius:999px;color:rgba(238,242,255,0.85);font-size:12.5px}
    .navLinks{display:flex;gap:12px;align-items:center}
    .navLinks a{color:rgba(167,139,250,0.95);text-decoration:none;font-weight:650}
    .navLinks a:hover{text-decoration:underline}
    main{max-width:1100px;margin:0 auto;padding:18px 18px 44px;display:grid;grid-template-columns:1.1fr 0.9fr;gap:18px}
    @media (max-width:920px){main{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid rgba(255,255,255,0.14);border-radius:var(--radius);box-shadow:var(--shadow);backdrop-filter:blur(12px)}
    .card.pad{padding:18px}
    .qBox{background: rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.12);border-radius:16px;padding:14px;margin-bottom:12px}
    .options{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px}
    @media (max-width:520px){.options{grid-template-columns:1fr}}
    .optBtn{border:1px solid rgba(255,255,255,0.16);background:rgba(255,255,255,0.06);color:var(--text);padding:12px;border-radius:14px;cursor:pointer;text-align:left;transition:transform 120ms ease}
    .optBtn.selected{border-color:rgba(34,197,94,0.55);background:rgba(34,197,94,0.13);box-shadow:0 10px 30px rgba(34,197,94,0.12)}
    /* Match/result area light pink background */
    #resultArea .miniItem, aside[aria-label="Results and shelters"] .miniItem, #quiz .miniItem{ background: #fff0f6; border-color: rgba(17,24,39,0.06); color:#111827 }

    /* Prominent match heading and layout */
    #resultArea .matchHeading{ display:block; text-align:center; font-size:38px; font-weight:800; letter-spacing:0.6px; margin:6px 0 12px; color:#111827 }
    @media (max-width:720px){
      #resultArea .matchHeading{ font-size:20px }
      #resultArea img.matchImage{ width:100%; height:auto; max-height:360px }
    }
  </style>
</head>
<body>
  <div class="sparkles"></div>

  <header>
    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"><span>üêæ</span></div>
        <div>
          <h1>Pawperfect Match</h1>
          <p class="subtitle">Take the lifestyle quiz and get matched with dog types that fit your life.</p>
        </div>
      </div>

      <div class="navLinks" style="margin-left:auto;" aria-label="Navigation">
        <a href="index.html">Home</a>
        <a href="quiz.html">Quiz</a>
        <a href="breeds.html">Breeds</a>
        <a href="resources.html">Resources</a>
        <a href="about.html">About Us</a>
      </div>
    </div>
  </header>

  <main>
    <!-- QUIZ (same quiz as original index) -->
    <section class="card pad" aria-label="Lifestyle quiz">
      <div class="sectionTitle">
        <h2>Quiz</h2>
        <div class="progressWrap" aria-label="Progress">
          <span id="progressText">0 / 10</span>
          <div class="progressBar" aria-hidden="true">
            <div class="progressFill" id="progressFill"></div>
          </div>
        </div>
      </div>

      <div id="questionHost"></div>

      <div class="actions">
        <button class="ghost" id="backBtn">Back</button>
        <button class="primary" id="nextBtn" disabled>Next</button>
        <button class="ghost" id="restartBtn" title="Start over">Restart</button>
      </div>

      <p class="footerNote">Note: This is a match suggestion, not a guarantee. Always meet the dog and consult shelter staff.</p>
    </section>

    <!-- RESULTS + SHELTERS (left intact) -->
    <aside class="sideGrid" aria-label="Results and shelters">
      <section class="card pad" aria-label="Your match">
        <div class="sectionTitle">
          <h2 style="font-size:20px;">Your PawPerfect Match!</h2>
          <span class="chip" id="statusChip">Complete the quiz</span>
        </div>

        <div id="resultArea">
          <div class="resultHero">
            <div class="badge" aria-hidden="true">‚ú®</div>
            <div>
              <h3>Ready when you are</h3>
              <p>Answer the questions on the left. When you finish, you‚Äôll get a best match plus runner-ups.</p>
            </div>
          </div>
        </div>
      </section>

      <section class="card pad" aria-label="Nearby shelters">
        <div class="sectionTitle">
          <h2>Nearby Adoption Options</h2>
          <span class="chip">üìç Optional</span>
        </div>

        <p class="subtitle" style="margin-top:0">Allow location to sort shelters by distance, or type your city/postal code to open a shelter search.</p>

        <div class="shelterControls">
          <button class="primary" id="locBtn">Use my location</button>

          <div class="input" title="Enter a city or postal/zip code">
            <span aria-hidden="true">üîé</span>
            <input id="placeInput" placeholder="City or postal/zip (example: M5V 2T6)" />
          </div>

          <button class="ghost" id="searchSheltersBtn">Search</button>
        </div>

        <div class="miniList" id="shelterList"></div>
      </section>

      <script>
        // Initialize location request when page loads
        window.addEventListener('load', () => {
          requestUserLocation();
          renderShelters(fetchedShelters);
        });

        // Location button handler
        document.getElementById('locBtn').addEventListener('click', () => {
          requestUserLocation();
          setTimeout(() => renderShelters(fetchedShelters), 1000);
        });

        // Render shelter list with distances
        function renderShelters(shelterList) {
          const shelterListDiv = document.getElementById('shelterList');
          if (!shelterList || shelterList.length === 0) {
            shelterListDiv.innerHTML = '<p style="color: #111827; font-size: 14px;">No shelters found. Try searching by city or postal code.</p>';
            return;
          }

          shelterListDiv.innerHTML = shelterList.map(s => `
            <div class="miniItem" style="background: #fff0f6; border-color: rgba(17,24,39,0.06); color:#111827">
              <div>
                <strong>${s.name}</strong>
                <p style="margin: 4px 0 0; font-size: 13px; color: rgba(17,24,39,0.75);">${s.city}</p>
              </div>
              <div style="text-align: right; font-size: 13px;">
                ${s.distance ? `<p style="margin: 0; font-weight: 600;">${s.distance} mi away</p>` : ''}
                <p style="margin: 4px 0 0; color: rgba(17,24,39,0.75);">${s.phone}</p>
              </div>
            </div>
          `).join('');
        }
      </script>
    </aside>
  </main>

  <div class="toast" id="toast" role="status" aria-live="polite"></div>

  <script>
    /*
      Pawperfect Match
      Single-file project (HTML/CSS/JS).
      The quiz and matching logic are copied here so `quiz.html` works as a standalone page.
    */

    // ---------------------------
    // 1) QUIZ DATA
    // ---------------------------
    const quiz = [
      {
        id: "activity",
        question: "How active are you on a normal week?",
        hint: "This helps us match energy level and exercise needs.",
        options: [
          { label: "Very active", desc: "I exercise a lot and love being outdoors", emoji:"üèÉ", points: { energy: 3 } },
          { label: "Moderately active", desc: "Walks and some activities", emoji:"üö∂", points: { energy: 2 } },
          { label: "Not very active", desc: "Short walks, chill lifestyle", emoji:"üõãÔ∏è", points: { energy: 1 } },
          { label: "It depends", desc: "Some weeks busy, some weeks free", emoji:"üìÖ", points: { energy: 2 } },
        ]
      },
      {
        id: "home",
        question: "What‚Äôs your living space like?",
        hint: "Some dogs do best with more space, others are great in apartments.",
        options: [
          { label: "Apartment / small space", desc: "Limited indoor space", emoji:"üè¢", points: { space: 1 } },
          { label: "Medium home", desc: "Some room to move around", emoji:"üè†", points: { space: 2 } },
          { label: "Large home", desc: "Plenty of room", emoji:"üè°", points: { space: 3 } },
          { label: "Home with a yard", desc: "Outdoor space available", emoji:"üåø", points: { space: 3 } },
        ]
      },
      {
        id: "time",
        question: "How much time can you give a dog each day?",
        hint: "Training, walks, and attention matter a lot.",
        options: [
          { label: "Lots of time", desc: "2+ hours for walks/training/play", emoji:"‚è≥", points: { time: 3 } },
          { label: "Some time", desc: "About 1‚Äì2 hours", emoji:"üïê", points: { time: 2 } },
          { label: "Limited time", desc: "Less than an hour most days", emoji:"‚ö°", points: { time: 1 } },
          { label: "Varies", desc: "My schedule changes", emoji:"üîÅ", points: { time: 2 } },
        ]
      },
      {
        id: "training",
        question: "How do you feel about training and routines?",
        hint: "Some breeds are easier for beginners; others need consistent training.",
        options: [
          { label: "I enjoy training", desc: "I‚Äôm patient and consistent", emoji:"üéØ", points: { train: 3 } },
          { label: "I can do basics", desc: "Sit, stay, leash training", emoji:"‚úÖ", points: { train: 2 } },
          { label: "I‚Äôm a beginner", desc: "I want a dog that‚Äôs easier to manage", emoji:"üå±", points: { train: 1 } },
          { label: "I‚Äôll get help", desc: "Classes or trainer are fine", emoji:"üßë‚Äçüè´", points: { train: 2 } },
        ]
      },
      {
        id: "grooming",
        question: "What grooming level are you okay with?",
        hint: "Some dogs shed a lot or need regular brushing/haircuts.",
        options: [
          { label: "Low grooming", desc: "Minimal shedding and brushing", emoji:"üßº", points: { groom: 1 } },
          { label: "Moderate", desc: "Weekly brushing is fine", emoji:"ü™Æ", points: { groom: 2 } },
          { label: "High", desc: "I‚Äôm okay with frequent grooming", emoji:"‚úÇÔ∏è", points: { groom: 3 } },
          { label: "No preference", desc: "I can manage whatever", emoji:"üôÇ", points: { groom: 2 } },
        ]
      },
      {
        id: "kids",
        question: "Any kids (or lots of visiting family) at home?",
        hint: "This helps match temperament and patience.",
        options: [
          { label: "Yes, younger kids", desc: "Need gentle and patient", emoji:"üß∏", points: { gentle: 3 } },
          { label: "Yes, older kids", desc: "Some energy is fine", emoji:"üéí", points: { gentle: 2 } },
          { label: "No kids", desc: "Adult household", emoji:"üßë‚Äçüíª", points: { gentle: 1 } },
          { label: "Sometimes", desc: "Kids visit sometimes", emoji:"üëã", points: { gentle: 2 } },
        ]
      },
      {
        id: "otherPets",
        question: "Do you have other pets?",
        hint: "Some dogs are more social with animals than others.",
        options: [
          { label: "Yes, a dog", desc: "Needs to be dog-friendly", emoji:"üê∂", points: { social: 3 } },
          { label: "Yes, a cat", desc: "Needs calmer prey drive", emoji:"üê±", points: { social: 2 } },
          { label: "Yes, small pets", desc: "Careful match needed", emoji:"üêπ", points: { social: 1 } },
          { label: "No other pets", desc: "This will be the only pet", emoji:"‚≠ê", points: { social: 2 } },
        ]
      },
      {
        id: "size",
        question: "Which dog size do you prefer?",
        hint: "This is an important preference and will prioritize matching dogs of the chosen size.",
        options: [
          { label: "Small (toy/small)", desc: "Prefer small companion dogs", emoji:"üß∏", points: { space: 1 } },
          { label: "Medium (mid-size)", desc: "Prefer medium-sized dogs", emoji:"üêï", points: { space: 2 } },
          { label: "Large (big dogs)", desc: "Prefer large, roomy dogs", emoji:"üê∫", points: { space: 3 } },
          { label: "No preference", desc: "I have no size preference", emoji:"‚≠ê", points: { } },
        ]
      },
      {
        id: "vibe",
        question: "Pick your ideal dog vibe.",
        hint: "This helps tune temperament and energy style.",
        options: [
          { label: "Adventure buddy", desc: "Hikes, runs, exploring", emoji:"üó∫Ô∏è", points: { energy: 3, time: 3 } },
          { label: "Balanced bestie", desc: "Play + relax", emoji:"‚öñÔ∏è", points: { energy: 2, gentle: 2 } },
          { label: "Cuddle champion", desc: "Calm, cozy companion", emoji:"üß°", points: { energy: 1, gentle: 3 } },
          { label: "Smart & focused", desc: "Learns tricks and tasks", emoji:"üß†", points: { train: 3 } },
        ]
      },
      {
        id: "shedding",
        question: "How do you feel about shedding?",
        hint: "Some dogs shed heavily, others barely at all.",
        options: [
          { label: "No shedding", desc: "Must be low or no-shed breeds", emoji:"‚ú®", points: {} },
          { label: "Little shedding", desc: "Minimal shedding is preferred", emoji:"ü™∂", points: {} },
          { label: "Fine with shedding", desc: "I can handle regular shedding", emoji:"üßπ", points: {} },
          { label: "No preference", desc: "Shedding doesn't matter to me", emoji:"‚≠ê", points: {} },
        ]
      }
    ];

    // ---------------------------
    // 2) DOG PROFILES (SCORING)
    // ---------------------------
    const dogProfiles = [
      {
        key: "cavalier",
        name: "Cavalier King Charles Spaniel (or similar mix)",
        icon: "üëë",
        description: "Affectionate, gentle, and great for calmer households. Often a strong match for people who want a cozy companion and manageable exercise needs.",
        ideal: { energy: 1, space: 1, time: 2, train: 2, groom: 2, gentle: 3, social: 2 },
        shedding: 2,
        tags: ["Sweet-tempered", "Great lap dog", "Moderate grooming"],
        tips: ["Daily walks still matter", "Brush regularly", "Good for apartments with walks"]
      },
      {
        key: "lab",
        name: "Labrador Retriever (or similar mix)",
        icon: "üéæ",
        description: "Friendly, social, and active. A classic family dog that loves play and needs daily exercise and attention.",
        ideal: { energy: 3, space: 2, time: 3, train: 2, groom: 2, gentle: 3, social: 3 },
        shedding: 2,
        tags: ["Playful", "People-friendly", "Needs exercise"],
        tips: ["Use training + routines", "Great for active families", "Expect shedding"]
      },
      {
        key: "golden",
        name: "Golden Retriever",
        icon: "üåü",
        description: "Friendly, patient, and great with families. Needs regular exercise and thrives on interaction and training.",
        ideal: { energy: 3, space: 2, time: 3, train: 2, groom: 2, gentle: 3, social: 3 },
        shedding: 2,
        tags: ["Family-friendly", "Eager to please", "Active"],
        tips: ["Daily exercise and training", "Good with kids", "Expect moderate shedding"]
      },
      {
        key: "shepherd",
        name: "German Shepherd / Working-dog mix",
        icon: "üõ°Ô∏è",
        description: "Loyal, intelligent, and needs structure. Best for people ready for training, routines, and daily mental + physical activity.",
        ideal: { energy: 3, space: 3, time: 3, train: 3, groom: 2, gentle: 2, social: 2 },
        shedding: 2,
        tags: ["Highly trainable", "Protective", "Needs a job"],
        tips: ["Consistent training and mental work", "Daily exercise required", "Great for active owners"]
      },
      {
        key: "french_bulldog",
        name: "French Bulldog",
        icon: "üòå",
        description: "Low-to-moderate energy, very people-focused, and often well-suited to apartment life; watch for heat and breathing issues.",
        ideal: { energy: 1, space: 1, time: 2, train: 1, groom: 1, gentle: 2, social: 2 },
        shedding: 2,
        tags: ["Chill", "Apartment-friendly", "Low exercise"],
        tips: ["Short daily walks", "Avoid extreme heat", "Basic training and socialization help"]
      },
      {
        key: "bulldog",
        name: "English Bulldog / Bulldog-type",
        icon: "üêæ",
        description: "Calm, affectionate, and good for smaller spaces; health considerations and moderate care are common.",
        ideal: { energy: 1, space: 1, time: 2, train: 1, groom: 1, gentle: 2, social: 2 },
        shedding: 2,
        tags: ["Calm", "Low exercise", "Affectionate"],
        tips: ["Short walks and care for folds", "Monitor breathing and heat", "Gentle training"]
      },
      {
        key: "poodle",
        name: "Poodle / Doodle-type (or similar low-shedding mix)",
        icon: "ü´ß",
        description: "Very smart and trainable, often lower shedding. Needs mental stimulation and consistent training.",
        ideal: { energy: 2, space: 2, time: 2, train: 3, groom: 3, gentle: 2, social: 2 },
        shedding: 3,
        tags: ["Smart", "Often low shedding", "High grooming"],
        tips: ["Regular grooming/haircuts", "Puzzle toys help", "Great for learning tricks"]
      },
      {
        key: "beagle",
        name: "Beagle",
        icon: "ü¶¥",
        description: "Curious, scent-driven, and friendly. Beagles need stimulation and secure outdoor spaces due to tracking instincts.",
        ideal: { energy: 2, space: 2, time: 2, train: 2, groom: 1, gentle: 2, social: 3 },
        shedding: 2,
        tags: ["Scent-driven", "Friendly", "Vocal"],
        tips: ["Secure yard recommended", "Positive training for scent distractions", "Daily exercise to prevent boredom"]
      },
      {
        key: "rottweiler",
        name: "Rottweiler",
        icon: "üõ°Ô∏è",
        description: "Confident and loyal; needs consistent training, socialization, and an owner who provides structure.",
        ideal: { energy: 2, space: 3, time: 3, train: 3, groom: 1, gentle: 2, social: 2 },
        shedding: 2,
        tags: ["Protective", "Strong", "Loyal"],
        tips: ["Early socialization", "Consistent training and leadership", "Good for experienced owners"]
      },
      {
        key: "yorkie",
        name: "Yorkshire Terrier",
        icon: "üéÄ",
        description: "Small, lively, and affectionate. Yorkies need grooming and gentle training but fit well in small homes.",
        ideal: { energy: 2, space: 1, time: 2, train: 1, groom: 3, gentle: 2, social: 2 },
        shedding: 3,
        tags: ["Tiny", "Bold", "High grooming"],
        tips: ["Daily brushing needed", "Professional grooming every 4-6 weeks", "Small dog training"]
      },
      {
        key: "dachshund",
        name: "Dachshund",
        icon: "ü™∂",
        description: "Curious and bold with a strong prey drive in some lines; good for smaller spaces but watch back health.",
        ideal: { energy: 2, space: 1, time: 2, train: 1, groom: 1, gentle: 2, social: 2 },
        shedding: 2,
        tags: ["Stubborn", "Playful", "Back-care needed"],
        tips: ["Avoid high jumps", "Manage weight and back health", "Short daily walks"]
      },
      {
        key: "boxer",
        name: "Boxer",
        icon: "ü•ä",
        description: "Playful, energetic, and affectionate. Boxers need activity, structure, and are great with families when trained.",
        ideal: { energy: 3, space: 3, time: 3, train: 2, groom: 1, gentle: 2, social: 3 },
        shedding: 2,
        tags: ["Energetic", "Family-friendly", "Playful"],
        tips: ["Daily vigorous play", "Consistent training", "Great with active families"]
      },
      {
        key: "pug",
        name: "Pug",
        icon: "üòÆ",
        description: "Friendly, affectionate, and a good apartment companion; watch for breathing and weight issues.",
        ideal: { energy: 1, space: 1, time: 2, train: 1, groom: 1, gentle: 3, social: 3 },
        shedding: 2,
        tags: ["Affectionate", "Low exercise", "Brachycephalic"],
        tips: ["Short walks", "Weight management", "Avoid heat and strenuous exercise"]
      },
      {
        key: "shihtzu",
        name: "Shih Tzu",
        icon: "üß∏",
        description: "Companion-focused, calm, and needs regular grooming; good for lap-loving owners.",
        ideal: { energy: 1, space: 1, time: 2, train: 1, groom: 3, gentle: 3, social: 2 },
        shedding: 3,
        tags: ["Companion", "Grooming", "Calm"],
        tips: ["Regular grooming", "Gentle training", "Great for apartment life"]
      },
      {
        key: "chihuahua",
        name: "Chihuahua",
        icon: "üå∂Ô∏è",
        description: "Very small and bold; often forms a strong bond with owners. Good for small spaces but needs confident handling.",
        ideal: { energy: 2, space: 1, time: 1, train: 1, groom: 1, gentle: 1, social: 1 },
        shedding: 2,
        tags: ["Tiny", "Loyal", "Alert"],
        tips: ["Careful socialization", "Small-dog training", "Watch for fragile handling"]
      },
      {
        key: "pomeranian",
        name: "Pomeranian",
        icon: "‚ùÑÔ∏è",
        description: "Small, fluffy, and lively. Pomeranians need grooming and engagement despite their size.",
        ideal: { energy: 2, space: 1, time: 2, train: 1, groom: 3, gentle: 2, social: 2 },
        shedding: 2,
        tags: ["Fluffy", "Alert", "Grooming"],
        tips: ["Regular brushing", "Small-dog socialization", "Short daily walks"]
      },
      {
        key: "husky",
        name: "Siberian Husky",
        icon: "‚ùÑÔ∏è",
        description: "High-energy, sociable, and escape-prone; needs exercise, secure fencing, and an owner prepared for active routines.",
        ideal: { energy: 3, space: 3, time: 3, train: 2, groom: 3, gentle: 2, social: 3 },
        shedding: 1,
        tags: ["High-energy", "Independent", "Shedding"],
        tips: ["Secure yard", "Daily vigorous exercise", "Grooming during blowouts"]
      },
      {
        key: "greatdane",
        name: "Great Dane",
        icon: "üè∞",
        description: "Gentle giant: low-to-moderate energy but needs space due to size. Good for owners who can handle large dogs and provide joint-care attention.",
        ideal: { energy: 2, space: 3, time: 2, train: 2, groom: 1, gentle: 2, social: 2 },
        shedding: 2,
        tags: ["Large", "Gentle", "Shorter lifespan"],
        tips: ["Space for size", "Manage joints and weight", "Short daily walks"]
      },
      {
        key: "doberman",
        name: "Doberman Pinscher",
        icon: "ü¶Å",
        description: "Loyal, alert, and highly trainable; best for experienced owners who provide leadership, training, and exercise.",
        ideal: { energy: 3, space: 3, time: 3, train: 3, groom: 1, gentle: 2, social: 2 },
        shedding: 2,
        tags: ["Protective", "Trainable", "Energetic"],
        tips: ["Structured training", "Daily exercise and mental work", "Good for active owners"]
      },
      {
        key: "aussie",
        name: "Australian Shepherd",
        icon: "üêë",
        description: "Highly active, intelligent, and needs mental/work outlets; excels in active homes with training and job-like tasks.",
        ideal: { energy: 3, space: 3, time: 3, train: 3, groom: 2, gentle: 2, social: 2 },
        shedding: 2,
        tags: ["Herding", "Very active", "Needs work"],
        tips: ["Obedience and agility", "Daily mental stimulation", "Great for active households"]
      },
      {
        key: "maltese",
        name: "Maltese",
        icon: "üå∏",
        description: "Small companion breed, affectionate and low-energy but needs regular grooming and gentle handling.",
        ideal: { energy: 1, space: 1, time: 1, train: 1, groom: 3, gentle: 3, social: 2 },
        shedding: 3,
        tags: ["Companion", "Grooming", "Small"],
        tips: ["Frequent grooming", "Gentle training", "Great lap dog"]
      },
      {
        key: "shiba",
        name: "Shiba Inu",
        icon: "üóª",
        description: "Independent, clean, and sometimes aloof; requires confident, consistent training and secure outdoor areas.",
        ideal: { energy: 2, space: 2, time: 2, train: 2, groom: 2, gentle: 1, social: 1 },
        shedding: 2,
        tags: ["Independent", "Cat-like", "Escape artist"],
        tips: ["Firm, consistent training", "Secure yard", "Socialization from young age"]
      },
      {
        key: "corgi",
        name: "Corgi (Pembroke/Cardigan)",
        icon: "üëë",
        description: "Smart, herding background, and energetic for their size; they enjoy activity and mental games.",
        ideal: { energy: 2, space: 2, time: 2, train: 2, groom: 2, gentle: 2, social: 2 },
        shedding: 2,
        tags: ["Herding", "Smart", "Stubborn"],
        tips: ["Daily walks", "Mental games", "Watch for back/weight issues"]
      },
      {
        key: "border_collie",
        name: "Border Collie",
        icon: "üß†",
        description: "Extremely intelligent and high-energy; excels with work, agility, and owners who can provide intense mental and physical outlets.",
        ideal: { energy: 3, space: 3, time: 3, train: 3, groom: 2, gentle: 2, social: 2 },
        shedding: 2,
        tags: ["Very high energy", "Brainy", "Needs work"],
        tips: ["Agility/obedience training", "Daily intense exercise", "Not ideal for inactive owners"]
      },
      {
        key: "dalmatian",
        name: "Dalmatian",
        icon: "üéØ",
        description: "Energetic and playful with a unique spotted coat. Dalmatians need significant exercise and active owners who can handle their stamina.",
        ideal: { energy: 3, space: 3, time: 3, train: 2, groom: 1, gentle: 2, social: 2 },
        shedding: 4,
        tags: ["High energy", "Spotted", "Active"],
        tips: ["High exercise needs", "Secure fencing", "Great for active owners"]
      },
      {
        key: "bichon_frise",
        name: "Bichon Frise",
        icon: "‚òÅÔ∏è",
        description: "Cheerful and hypoallergenic companion breed. Great for apartments but needs regular grooming and can be prone to separation anxiety.",
        ideal: { energy: 2, space: 1, time: 2, train: 2, groom: 3, gentle: 2, social: 3 },
        shedding: 1,
        tags: ["Hypoallergenic", "Cheerful", "Grooming"],
        tips: ["Regular grooming crucial", "Great for apartments", "Prone to separation anxiety"]
      },
      {
        key: "miniature_pinscher",
        name: "Miniature Pinscher",
        icon: "‚ö°",
        description: "Small but spirited and energetic. Min pins have high prey drive and need confident, firm training and socialization.",
        ideal: { energy: 2, space: 1, time: 2, train: 2, groom: 1, gentle: 1, social: 1 },
        shedding: 2,
        tags: ["Tiny", "Energetic", "High prey drive"],
        tips: ["Firm training needed", "High prey drive", "Good for experienced small dog owners"]
      },
      {
        key: "schnauzer",
        name: "Schnauzer",
        icon: "üßî",
        description: "Alert and intelligent watchdog with a distinctive wiry coat. Schnauzers are loyal and make excellent family companions.",
        ideal: { energy: 2, space: 2, time: 2, train: 2, groom: 3, gentle: 2, social: 2 },
        shedding: 1,
        tags: ["Alert", "Loyal", "Grooming"],
        tips: ["Regular hand-stripping", "Excellent watchdogs", "Good family dogs"]
      }
    ];

    // ---------------------------
    // 3) SHELTER DATA & GEOLOCATION
    // ---------------------------
    let userLocation = null;
    let fetchedShelters = [];

    // Fallback shelters (if geolocation fails or API doesn't return results)
    const fallbackShelters = [
      { name: "Happy Tails Animal Shelter", city: "Downtown", lat: 40.7128, lon: -74.0060, phone: "(555) 123-4567", distance: null },
      { name: "Northside Rescue Center", city: "North Area", lat: 40.7580, lon: -73.9855, phone: "(555) 222-0199", distance: null },
      { name: "Lakeshore Adoption Hub", city: "Lakeshore", lat: 40.6892, lon: -74.0445, phone: "(555) 987-0001", distance: null },
    ];

    // Request user's geolocation
    function requestUserLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (position) => {
            userLocation = {
              lat: position.coords.latitude,
              lon: position.coords.longitude
            };
            fetchRealShelters(userLocation.lat, userLocation.lon);
          },
          (error) => {
            console.log("Geolocation denied or unavailable, using fallback shelters");
            fetchedShelters = fallbackShelters;
          }
        );
      } else {
        fetchedShelters = fallbackShelters;
      }
    }

    // Fetch real shelters using Overpass API (free, no auth needed)
    async function fetchRealShelters(lat, lon) {
      try {
        const radius = 10000; // 10km search radius
        const query = `[bbox=${lat-0.1},${lon-0.1},${lat+0.1},${lon+0.1}];(node["amenity"="animal_shelter"];way["amenity"="animal_shelter"];);out geom;`;
        const url = `https://overpass-api.de/api/interpreter?data=${encodeURIComponent('[out:json];' + query)}`;
        
        const response = await fetch(url);
        const data = await response.json();
        
        if (data.elements && data.elements.length > 0) {
          fetchedShelters = data.elements.slice(0, 5).map(shelter => {
            const shelterLat = shelter.lat || (shelter.center ? shelter.center.lat : lat);
            const shelterLon = shelter.lon || (shelter.center ? shelter.center.lon : lon);
            const distance = calculateDistance(lat, lon, shelterLat, shelterLon);
            return {
              name: shelter.tags?.name || "Animal Shelter",
              city: shelter.tags?.["addr:city"] || "Nearby",
              lat: shelterLat,
              lon: shelterLon,
              phone: shelter.tags?.["contact:phone"] || "(555) 000-0000",
              distance: distance
            };
          }).sort((a, b) => a.distance - b.distance);
        } else {
          fetchedShelters = fallbackShelters;
        }
      } catch (error) {
        console.log("Could not fetch shelters from API, using fallback");
        fetchedShelters = fallbackShelters;
      }
    }

    // Calculate distance between two coordinates (Haversine formula)
    function calculateDistance(lat1, lon1, lat2, lon2) {
      const R = 3959; // Earth's radius in miles
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) + 
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
                Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return Math.round(R * c * 10) / 10;
    }

    const shelters = fallbackShelters;

    const availableDogs = [
      { id: 1, name: "Buddy", breedKey: "lab", breedLabel: "Labrador mix", age: "2 yrs", shelterIdx: 0, img: "https://images.unsplash.com/photo-1517849845537-4d257902454a?q=80&w=1200&auto=format&fit=crop&ixlib=rb-4.0.3&s=2c5f3d4f3b6d4f6a8f0f1e6d2b1a7c9e" },
      { id: 2, name: "Maya", breedKey: "poodle", breedLabel: "Poodle mix", age: "3 yrs", shelterIdx: 2, img: "https://images.unsplash.com/photo-1546182990-dffeafbe841d?q=80&w=1200&auto=format&fit=crop&ixlib=rb-4.0.3&s=1b4c6a8b2a5e4f0b3d2c1a6e8f7b9c0d" },
      { id: 3, name: "Charlie", breedKey: "greyhound", breedLabel: "Greyhound mix", age: "4 yrs", shelterIdx: 3, img: "https://images.unsplash.com/photo-1507149833265-60c372daea22?q=80&w=1200&auto=format&fit=crop&ixlib=rb-4.0.3&s=7a4d3c6e9b1a2c8d5e6f7a8b9c0d1e2f" },
    ];

    // Map of custom local images for specific breeds.
    // Place your photos here (e.g. images/chihuahua.svg or .jpg). The quiz will prefer these over Unsplash.
    const customBreedImages = {
      chihuahua: 'chihuahua.jpg',
      cavalier: 'https://pethelpful.com/.image/w_1080,q_auto:good,c_limit/MTk0OTAxODYyMDkxNDY1ODkw/5-things-you-should-know-before-owning-a-cavalier-king-charles-spaniel.jpg?arena_f_auto',
      golden: 'https://www.thesprucepets.com/thmb/kCP2nrYde0lxY1vKcyDoWTQnZ54=/750x0/filters:no_upscale():max_bytes(150000):strip_icc():format(webp)/27579211_1592220587499910_4895961142016344064_n-5b353a8dc9e77c003795239d.jpg',
      lab: 'https://www.dailypaws.com/thmb/rwL54b2y1kllOZLhfppcfbkrmaU=/1500x0/filters:no_upscale():max_bytes(150000):strip_icc()/golden-lab-puppy-664540826-2000-b29bcc58c71a498eb5ecd5d0b2b8e82b.jpg',
      shepherd: 'https://newapproach.ca/wp-content/uploads/2021/09/shepherd-dog-puppy-dog-4357790-1024x685.jpg',
      beagle: 'https://dogtime.com/wp-content/uploads/sites/12/2023/07/GettyImages-936521948-e1690235595257.jpg?w=1024',
      french_bulldog: 'https://media.cnn.com/api/v1/images/stellar/prod/230315104543-02-french-bulldog-stock.jpg?c=16x9&q=h_653,w_1160,c_fill/f_avif',
      bulldog: 'https://i1.pickpik.com/photos/94/974/364/bulldog-cute-easter-animal-preview.jpg',
      poodle: 'https://thehappypuppysite.com/wp-content/uploads/2018/01/Toy-Poodle-HP-long.jpg',
      rottweiler: 'https://animalfair.com/wp-content/uploads/2016/07/Screen-Shot-2016-07-18-at-12.34.21-PM.png',
      yorkshire_terrier: 'https://www.animalbehaviorcollege.com/wp-content/uploads/2015/07/yorkshire-terrier.jpg',
      yorkie: 'https://a-z-animals.com/media/2022/05/yorkie2.jpg',
      dachshund: 'https://pethelpful.com/.image/w_1080,q_auto:good,c_limit/NDowMDAwMDAwMDAwMTI0NzA3/cute-dachshund-puppies.jpg?arena_f_auto',
      boxer: 'https://s.yimg.com/ny/api/res/1.2/b_bHBLXvluXN1_3mXdXqBw--/YXBwaWQ9aGlnaGxhbmRlcjt3PTY0MDtoPTQyNg--/https://media.zenfs.com/en/dog_time_927/40d21c1f8b20923ed065d4e09da82d2c',
      pug: 'https://cdn05.zipify.com/YbsM3chL8S78YP9YMpIiYAvmiNA=/fit-in/3840x0/020853f9b4d74310a51e3174c8e3db45/pot013-blog-hero-horizontal-1.jpeg',
      shihtzu: 'https://www.animalkingdomaz.com/wp-content/uploads/Shih-Tzu-2-300x300.jpg',
      pomeranian: 'https://www.rover.com/blog/wp-content/uploads/iStock-1422682177-1024x683.jpg',
      husky: 'https://t4.ftcdn.net/jpg/06/27/80/93/360_F_627809340_QUwyhZUUSBuVoiSpRjLGOuFSguJQ1CdY.jpg',
      great_dane: 'https://www.scotsman.com/webimg/b25lY21zOjZlZTMwMGRkLWNiZDItNGVkMy05YTEzLTNiNTQ3NDYyMjQ1ZDphYjNhOTI5NC0zZGNmLTRmN2MtOWNkYy0zMGMzMjMzZDlmZTA=.jpg?crop=3:2,smart&trim=&width=990&quality=65&enable=upscale',
      doberman: 'https://images.ctfassets.net/nx3pzsky0bc9/5JNIP0KkbMkF8sjyeVFcvt/d2db4e388b752e69935a6001b0259efa/Doberman_feature_image.png?q=65&w=804&fm=avif',
      border_collie: 'https://dogtime.com/wp-content/uploads/sites/12/2023/11/E1A4DAF1-4BF1-43F1-B23F-D6C7215FEBC5-e1700655081549.jpeg?w=1024',
      maltese: 'https://images.ctfassets.net/5gwznsevsdag/26aZgpxRz5JQmHkMn8W3vl/95e9eae3ab1b3aca41efce1f645c0dd0/BLOG_BREED_IMAGES_MALTESE_1255b1c5-b936-4700-97de-048fc8e2fb78.jpg?fm=avif&q=40&w=750&h=750&fit=fill',
      bullmastiff: 'https://www.petpaw.com.au/wp-content/uploads/2014/04/Bullmastiff-3.jpg',
      corgi: 'https://www.petplace.com/article/dogs/just-for-fun/media_14f0c12d2db85798062879451e9f3132f2a54925a.jpeg?width=2000&format=webply&optimize=medium',
      shiba: 'https://cdn.shopify.com/s/files/1/1083/2612/files/shutterstock_1853181622_480x480.jpg?v=1707885098',
      dalmatian: 'https://dogtime.com/wp-content/uploads/sites/12/2024/07/IMG_2518-e1720009188826.jpeg?w=1024',
      bichon_frise: 'https://www.dogster.com/wp-content/uploads/2024/09/Adorable-perro-Bichon-Frise_Eudyptula_Shutterstock.jpg.webp',
      miniature_pinscher: 'https://www.akc.org/wp-content/uploads/2017/11/Miniature-Pinscher-leaping-through-a-meadow.jpg',
      schnauzer: 'https://bowwowinsurance.com.au/wp-content/uploads/2018/10/shutterstock_1836759934_crop-ed-Dog-laying-on-pier-of-river-green-background.-Mini-schnauzer-pup-salt-and-pepper.jpg'
    };

    // Last scored profiles (used to show matching available dogs)
    let lastScored = null;

    // ---------------------------
    // 4) STATE
    // ---------------------------
    let step = 0;
    const answers = new Array(quiz.length).fill(null);
    let userScores = null;  // computed after completion
    let userLocation = null; // {lat, lon}

    // ---------------------------
    // 5) DOM HELPERS
    // ---------------------------
    const host = document.getElementById("questionHost");
    const backBtn = document.getElementById("backBtn");
    const nextBtn = document.getElementById("nextBtn");
    const restartBtn = document.getElementById("restartBtn");
    const progressText = document.getElementById("progressText");
    const progressFill = document.getElementById("progressFill");
    const statusChip = document.getElementById("statusChip");
    const resultArea = document.getElementById("resultArea");
    const shelterList = document.getElementById("shelterList");
    const locBtn = document.getElementById("locBtn");
    const placeInput = document.getElementById("placeInput");
    const searchSheltersBtn = document.getElementById("searchSheltersBtn");
    const toast = document.getElementById("toast");

    function showToast(msg){
      toast.textContent = msg;
      toast.classList.add("show");
      clearTimeout(showToast._t);
      showToast._t = setTimeout(()=> toast.classList.remove("show"), 2400);
    }

    // ---------------------------
    // 6) QUIZ RENDER
    // ---------------------------
    function renderQuestion(){
      const q = quiz[step];
      const picked = answers[step];

      progressText.textContent = `${step} / ${quiz.length}`;
      progressFill.style.width = `${(step / quiz.length) * 100}%`;

      host.innerHTML = `
        <div class="qBox">
          <div class="qTop">
            <div style="flex:1; min-width:0;">
              <p class="qText">${q.question}</p>
              <p class="qHint">${q.hint}</p>
            </div>
            <div class="qNum">Question ${step + 1} of ${quiz.length}</div>
          </div>

          <div class="options" role="group" aria-label="Answer choices">
            ${q.options.map((opt, idx) => `
              <button class="optBtn ${picked===idx ? "selected":""}" data-idx="${idx}">
                <div class="emoji" aria-hidden="true">${opt.emoji}</div>
                <div class="optText">
                  <b>${opt.label}</b>
                  <small>${opt.desc}</small>
                </div>
              </button>
            `).join("")}
          </div>
        </div>
      `;

      nextBtn.disabled = (picked === null);
      const floating = document.getElementById('floatingNext');
      if (floating) floating.style.display = nextBtn && !nextBtn.disabled ? 'inline-block' : 'none';
      backBtn.disabled = (step === 0);

      host.querySelectorAll(".optBtn").forEach(btn => {
        btn.addEventListener("click", () => {
          const idx = Number(btn.getAttribute("data-idx"));
          answers[step] = idx;
          renderQuestion();
          setTimeout(() => {
            if (nextBtn && !nextBtn.disabled) nextBtn.click();
          }, 260);
        });
      });

      nextBtn.textContent = (step === quiz.length - 1) ? "Finish" : "Next";
    }

    // ---------------------------
    // 7) SCORING
    // ---------------------------
    function computeUserScores(){
      const totals = { energy:0, space:0, time:0, train:0, groom:0, gentle:0, social:0 };
      for (let i = 0; i < quiz.length; i++){
        const pickedIdx = answers[i];
        const opt = quiz[i].options[pickedIdx];
        for (const k in opt.points){
          totals[k] += opt.points[k];
        }
      }

      const scaled = {};
      for (const k in totals){
        const v = totals[k];
        let s = 1;
        if (v >= 6) s = 3;
        else if (v >= 3) s = 2;
        scaled[k] = s;
      }
      return { totals, scaled };
    }

    function profileScore(profile, userScaled){
      let score = 0;
      const keys = Object.keys(profile.ideal);
      for (const k of keys){
        const diff = Math.abs(profile.ideal[k] - userScaled[k]);
        if (diff === 0) score += 3;
        else if (diff === 1) score += 2;
        else score += 1;
      }
      return score;
    }

    function levelLabel(k, n){
      const names = {
        energy: ["Low energy", "Medium energy", "High energy"],
        space: ["Small space ok", "Medium space", "Needs more space"],
        time: ["Low time needs", "Moderate time", "High time needs"],
        train: ["Beginner-friendly", "Moderate training", "Needs training"],
        groom: ["Low grooming", "Moderate grooming", "High grooming"],
        gentle: ["Independent", "Balanced", "Very gentle"],
        social: ["Cautious", "Moderate social", "Very social"]
      };
      return names[k][Math.max(0, Math.min(2, n-1))];
    }

    function renderResults(){
      userScores = computeUserScores();

      const scored = dogProfiles.map(p => ({
        ...p,
        matchScore: profileScore(p, userScores.scaled)
      })).sort((a,b)=> b.matchScore - a.matchScore);

      // If the user selected a size preference, strictly prefer profiles matching that size.
      // We consider profile.ideal.space: 1=small,2=medium,3=large.
      let filtered = scored;
      const sizeQIndex = quiz.findIndex(q => q.id === 'size');
      if (sizeQIndex !== -1){
        const sizeAnswer = answers[sizeQIndex];
        if (sizeAnswer !== null && sizeAnswer !== undefined){
          const ansToSpaces = {
            0: [1], // small
            1: [2], // medium
            2: [3], // large
            3: [1,2,3] // no preference
          };
          const desired = ansToSpaces[sizeAnswer] || [1,2,3];
          const matches = scored.filter(p => desired.includes(p.ideal.space));
          if (matches.length) filtered = matches;
        }
      }

      // Filter by shedding preference (non-negotiable)
      // Shedding levels: 1=high, 2=moderate, 3=low/no-shed
      const sheddingQIndex = quiz.findIndex(q => q.id === 'shedding');
      if (sheddingQIndex !== -1){
        const sheddingAnswer = answers[sheddingQIndex];
        if (sheddingAnswer !== null && sheddingAnswer !== undefined){
          const ansToShedding = {
            0: [3], // no shedding - only low/no-shed dogs
            1: [2, 3], // little shedding - moderate or low
            2: [1, 2, 3], // fine with shedding - all
            3: [1, 2, 3] // no preference - all
          };
          const desired = ansToShedding[sheddingAnswer] || [1,2,3];
          const matches = filtered.filter(p => desired.includes(p.shedding));
          if (matches.length) filtered = matches;
        }
      }

      lastScored = filtered;

      const top = filtered[0];
      const runnerUps = filtered.slice(1,3);

      statusChip.textContent = "Match ready ‚úÖ";

      const traitPills = [
        { k:"energy", val: top.ideal.energy },
        { k:"space", val: top.ideal.space },
        { k:"train", val: top.ideal.train },
        { k:"groom", val: top.ideal.groom },
      ].map(t => `<div class="pill">${levelLabel(t.k, t.val)}</div>`).join("");

      const cleanName = top.name.replace(/\s*\(.*?\)/, '').replace(/[^a-zA-Z0-9 ]/g, '').trim();

      // Prefer a local custom image if provided for the breed; otherwise fall back to Unsplash.
      const customImg = customBreedImages[top.key];
      const topImage = customImg ? customImg : `https://source.unsplash.com/800x600/?${encodeURIComponent(cleanName)}`;

      // Big heading text (caps) per request ‚Äî will read e.g. "YOU HAVE MATCHED WITH THE CHIHUAHUA"
      const headingText = `YOU HAVE MATCHED WITH THE ${cleanName.toUpperCase()}`;

      resultArea.innerHTML = `
        <div>
          <h2 id="matchHeading" class="matchHeading">${headingText}</h2>
        </div>

        <div class="resultHero" style="align-items:center; gap:18px; flex-direction:column; text-align:center;">
          <img class="matchImage" src="${topImage}" alt="${top.name}" style="width:700px;height:500px;object-fit:cover;border-radius:12px;border:1px solid rgba(255,255,255,0.06);margin-bottom:32px" />
          <div>
            <p style="margin:6px 0 8px;font-size:18px;">${top.description}</p>
            <div class="pillRow">${traitPills}</div>
          </div>
        </div>

        <div class="miniList" style="margin-top:14px;">
          <div class="miniItem">
            <div>
              <h4 style="font-size:22px;margin:0;">Why this match works</h4>
              <p style="font-size:17px;">${top.tags.join(" ‚Ä¢ ")}</p>
              <p style="margin-top:6px;font-size:17px;">Tips: ${top.tips.join(" ‚Ä¢ ")}</p>
            </div>
            <div class="miniRight" style="align-items:flex-start;">
              <span class="scoreTag" style="font-size:20px;">Match score: <b>${top.matchScore}</b></span>
              <span style="color:rgba(238,242,255,0.7);">Top pick</span>
            </div>
          </div>
        </div>

        <div class="sectionTitle" style="margin-top:14px;">
          <h2 style="font-size:22px; margin:0;">Runner-ups</h2>
          <span class="chip">Also good fits</span>
        </div>

        <div class="miniList">
          ${runnerUps.map(p => {
            const runnerImage = customBreedImages[p.key] || `https://source.unsplash.com/800x600/?${encodeURIComponent(p.name)}`;
            return `
            <div class="miniItem" style="gap:14px;">
              <img src="${runnerImage}" alt="${p.name}" style="width:120px; height:100px; object-fit:cover; border-radius:10px; flex-shrink:0;" onerror="this.src='https://source.unsplash.com/800x600/?dog'">
              <div>
                <h4 style="font-size:17px;">${p.icon} ${p.name}</h4>
                <p style="font-size:15px;">${p.tags.join(" ‚Ä¢ ")}</p>
              </div>
              <div class="miniRight">
                <span class="scoreTag" style="font-size:15px;">Score: <b>${p.matchScore}</b></span>
              </div>
            </div>
            `;
          }).join("")}
        </div>

        <p class="footerNote" style="margin-top:12px;">
          If you want, take your result and tell a shelter staff member. They can suggest real dogs with similar needs and temperament.
        </p>
      `;

      progressText.textContent = `${quiz.length} / ${quiz.length}`;
      progressFill.style.width = `100%`;

      renderShelters();

      // Scroll to the match section so the user sees the heading and result
      setTimeout(() => {
        const target = document.getElementById('matchCard') || document.getElementById('resultArea');
        if (target) {
          target.scrollIntoView({ behavior: 'smooth', block: 'start' });
          // briefly focus for accessibility
          try { target.setAttribute('tabindex','-1'); target.focus(); } catch(e){}
        }
      }, 200);
    }

    // ---------------------------
    // 8) SHELTERS (DISTANCE SORT)
    // ---------------------------
    function haversineKm(lat1, lon1, lat2, lon2){
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a =
        Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(lat1 * Math.PI/180) * Math.cos(lat2 * Math.PI/180) *
        Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    function renderShelters(){
      let list = shelters.map(s => ({...s}));

      if (userLocation){
        list.forEach(s => {
          s.km = haversineKm(userLocation.lat, userLocation.lon, s.lat, s.lon);
        });
        list.sort((a,b)=> (a.km ?? 9999) - (b.km ?? 9999));
      }

      let recommendedHtml = "";
      if (lastScored){
        const keys = [lastScored[0].key, ...(lastScored[1] ? [lastScored[1].key] : [])];
        const matches = availableDogs.filter(d => keys.includes(d.breedKey));
        if (matches.length){
          recommendedHtml += `
            <div class="sectionTitle">
              <h2>Available dogs matching your result</h2>
              <span class="chip">From local shelters</span>
            </div>
          `;

          recommendedHtml += matches.map(d => {
            const s = shelters[d.shelterIdx] || { name: "Unknown", lat:null, lon:null, phone: "" };
            const km = (userLocation && s.lat != null) ? haversineKm(userLocation.lat, userLocation.lon, s.lat, s.lon).toFixed(1) : null;
            const phoneLink = s.phone ? `tel:${s.phone.replace(/[^0-9+]/g,'')}` : '#';

            return `
              <div class="miniItem">
                <div style="display:flex; gap:12px; align-items:center;">
                  <img src="${d.img}" alt="${d.name}" style="width:96px; height:64px; object-fit:cover; border-radius:8px;" />
                  <div>
                    <h4>${d.name} ‚Äî ${d.breedLabel || d.breedKey}</h4>
                    <p>${d.age} ‚Ä¢ Shelter: ${s.name}</p>
                    ${km ? `<p style="margin-top:6px;">Approx distance: <b>${km} km</b></p>` : ''}
                  </div>
                </div>
                <div class="miniRight">
                  <a class="link" href="${phoneLink}">${s.phone ? 'Call shelter' : 'Contact'}</a>
                  <a class="link" href="https://www.google.com/maps/search/?api=1&query=${s.lat},${s.lon}" target="_blank" style="display:block;margin-top:8px">View on map</a>
                </div>
              </div>
            `;
          }).join("");
        }
      }

      const sheltersHtml = list.map(s => `
        <div class="miniItem">
          <div>
            <h4>üè† ${s.name}</h4>
            <p>Area: ${s.city} ‚Ä¢ Phone: ${s.phone}</p>
            ${userLocation && s.km != null ? `<p style="margin-top:6px;">Approx distance: <b>${s.km.toFixed(1)} km</b></p>` : ""}
          </div>
          <div class="miniRight">
            <span class="scoreTag">${userLocation ? "Sorted" : "Sample list"}</span>
          </div>
        </div>
      `).join("");

      shelterList.innerHTML = recommendedHtml + sheltersHtml;
    }

    async function useMyLocation(){
      if (!navigator.geolocation){
        showToast("Geolocation not supported in this browser.");
        return;
      }
      showToast("Requesting location‚Ä¶");
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          userLocation = { lat: pos.coords.latitude, lon: pos.coords.longitude };
          renderShelters();
          showToast("Shelters sorted by nearest.");
        },
        () => {
          showToast("Location permission denied (you can still use the sample list).");
        },
        { enableHighAccuracy: true, timeout: 8000 }
      );
    }

    function openShelterSearch(){
      const place = placeInput.value.trim();
      if (!place){
        showToast("Type a city or postal/zip first.");
        return;
      }

      const url = `https://www.petfinder.com/search/dogs-for-adoption/?location=${encodeURIComponent(place)}`;

      window.open(url, "_blank", "noopener,noreferrer");
      showToast("Opened adoption search in a new tab.");
    }

    // ---------------------------
    // 9) BUTTONS / NAV
    // ---------------------------
    backBtn.addEventListener("click", () => {
      if (step > 0){
        step--;
        renderQuestion();
      }
    });

    nextBtn.addEventListener("click", () => {
      if (answers[step] === null) return;

      if (step < quiz.length - 1){
        step++;
        renderQuestion();
      } else {
        renderResults();
      }
    });

    restartBtn.addEventListener("click", () => {
      step = 0;
      for (let i = 0; i < answers.length; i++) answers[i] = null;
      userScores = null;
      statusChip.textContent = "Complete the quiz";
      resultArea.innerHTML = `
        <div class="resultHero">
          <div class="badge" aria-hidden="true">‚ú®</div>
          <div>
            <h3>Ready when you are</h3>
            <p>
              Answer the questions on the left. When you finish, you‚Äôll get a best match plus runner-ups.
            </p>
            <div class="pillRow">
              <div class="pill">Energy</div>
              <div class="pill">Space</div>
              <div class="pill">Training</div>
              <div class="pill">Grooming</div>
            </div>
          </div>
        </div>
      `;
      renderQuestion();
      showToast("Restarted the quiz.");
    });

    locBtn.addEventListener("click", useMyLocation);
    searchSheltersBtn.addEventListener("click", openShelterSearch);

    // ---------------------------
    // 10) INIT
    // ---------------------------
    renderQuestion();
    renderShelters();
  </script>
</body>
</html>